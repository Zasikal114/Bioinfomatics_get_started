# Part III. 2.1 RNA-seq - Expression Matrix
## 1)
### CPM/RPM(每百万 reads 数)
CPM=某基因reads数/百万总reads数

仅校正测序深度，忽略基因长度。适用于基因长度相似的情况。
### RPKM(每千碱基每百万 reads 数)
RPKM=某基因reads数/(百万总reads数×某基因kb长度)

单端测序，同时校正测序深度和基因长度。适用于样本内基因间比较。
### FPKM(每千碱基每百万 reads 数)
FPKM=RPKM/2
 
双端测序，同时校正测序深度和基因长度。适用于样本内基因间比较。
### TPM（每百万转录本数）
TPM=RPKM*10^6/总RPKM

同时校正测序深度、基因长度和转录组组成差异。适用于样本间的比较。
### TMM（Trimmed Mean of M-values/M值的截尾均值）
M值：对数比值

M=log2(样本A中某基因的表达量/样本B（参考样本）中某基因的表达量)

​​A值:(表达水平均值)

A=​​log2(样本A中某基因的表达量×样本B中某基因的表达量)/2

之后去除极端值，计算加权平均的缩放因子，再进行校正。

假设大部分基因非差异表达。对差异基因稳健性较高。适合样本间差异表达分析。
### RLE(相对对数表达)
对基因 g，计算其在所有样本中表达量的几何均值

对于样本 i 中的基因 g，计算其表达量与几何均值的比值

对样本 i，取所有基因比值的中位数作为缩放因子

对样本 i，计算每个基因 g 表达量与缩放因子的比值作为归一化的表达量

假设大部分基因表达比例稳定。对差异基因的稳健性较低。适合多个样本的差异表达分析。
## 2)
### E
### D
### A
## 3)
```
root@featurecount_docker:/home/test# /usr/local/bin/infer_experiment.py -r GTF/Arabidopsis_thaliana.TAIR10.34.bed -i bam/Shape02.bam
Reading reference gene model GTF/Arabidopsis_thaliana.TAIR10.34.bed ... Done
Loading SAM/BAM file ...  Total 200000 usable reads were sampled


This is PairEnd Data
Fraction of reads failed to determine: 0.0315
Fraction of reads explained by "1++,1--,2+-,2-+": 0.4769
Fraction of reads explained by "1+-,1-+,2++,2--": 0.4916
```
两类比例接近，说明是Strand Non-specific的次序协议。
```
root@featurecount_docker:/home/test# /home/software/subread-2.0.3-source/bin/featureCounts \-s 0 -p -t exon -g gene_id \-a GTF/Arabidopsis_thaliana.TAIR10.34.gtf \-o result/Shape02.featurecounts.exon.txt bam/Shape02.bam

root@featurecount_docker:/home/test/result# grep "AT1G09530" Shape02.featurecounts.exon.txt
AT1G09530       1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1;1   3075768;3075768;3075768;3076401;3076401;3076401;3076459;3076459;3076459;3077173;3077173;3077173;3077173;3077378;3077378;3077378;3077378;3077378;3077378;3078346;3078346;3078346;3078346;3078346;3078346;3078545;3078545;3078545;3078545;3078545;3078545;3078843;3078843;3078843;3078843;3078843;3078843;3078984;3078984;3078984;3078984;3078984;3078984 3075852;3075852;3075852;3077286;3076808;3076748;3076808;3077286;3076748;3077286;3077286;3077286;3077286;3078257;3078257;3078257;3078257;3078257;3078257;3078453;3078453;3078453;3078453;3078453;3078453;3078610;3078610;3078610;3078610;3078610;3078610;3078908;3078908;3078908;3078908;3078908;3078908;3079544;3079544;3079544;3079654;3079654;3079654 +;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+;+   2762    86
```
有86个counts
## 4)
```
# 1.获取文件目录
file_list <- list.files(path = "tumor-transcriptome-demo",
                        pattern = "\\.txt$",
                        recursive = TRUE,
                        full.names = TRUE)

# 检查是否找到文件（重要！）
if(length(file_list) == 0) stop("未找到任何.txt文件，请检查路径")

count_list <- list()
group <- character()
gene_ids <- NULL

for (i in seq_along(file_list)) {
  file <- file_list[i]
  data <- read.delim(file, skip = 2, header = TRUE)
  
  # 明确指定count列位置（原代码假设最后一列可能有误）
  counts <- data[, 7]  # featureCounts输出第7列为counts
  
  # 初始化基因名
  if(is.null(gene_ids)) {
    gene_ids <- data$Geneid
  } else {
    if(!identical(data$Geneid, gene_ids)) {
      stop(paste(file, "中的基因ID不匹配"))
    }
  }
  
  count_list[[i]] <- counts
  # 更稳健的分组信息提取方法
  group[i] <- strsplit(dirname(file), "/")[[1]][2] # 假设路径结构为 主目录/癌症类型/文件
}

# 转换为矩阵并添加名称（修复维度错误的核心步骤）
count_matrix <- matrix(unlist(count_list), 
                       ncol = length(count_list),
                       dimnames = list(gene_ids, 
                                       sub("\\.txt$", "", basename(file_list))))
# 2. 数据预处理
y <- DGEList(counts = count_matrix, group = group)
keep <- filterByExpr(y)
y <- y[keep, , keep.lib.sizes = FALSE]
y <- calcNormFactors(y)
# 3. 计算logCPM和Z-score
logcpm <- cpm(y, log = TRUE)
z_scores <- t(scale(t(logcpm)))
# 4. 绘制热图
annotation_col <- data.frame(CancerType = factor(group))
rownames(annotation_col) <- colnames(z_scores)

pheatmap(z_scores,
         cluster_cols = TRUE,
         show_rownames = FALSE,
         show_colnames = FALSE,
         annotation_col = annotation_col,
         color = colorRampPalette(c("blue", "white", "red"))(50),
         main = "Z-score of logCPM Expression")
```
![heatmap](Rplot05.png)








​
 

